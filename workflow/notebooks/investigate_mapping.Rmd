---
title: Investigation of Primer Mapping for Issues
author: Alfred Hubbard
output:
  html_notebook: default
  pdf_document: default
  github_document: default
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
# Load required libraries ----------------------------------------------
# These will be referenced without the `package::` construct, and thus 
# are loaded second to avoid masking
library(dplyr)
library(ggplot2)
library(knitr)
library(magrittr)
library(readr)
library(stringr)

# Don't include code in PDF output
opts_chunk$set(echo = ! is_latex_output(), out.width = "100%")
# Set default ggplot2 theme
theme_set(theme_bw())

# Hardcode parameters. These are not passed as shell arguments because 
# hardcoded values facilitate development and this document is not 
# meant to be usable with other projects.
inp <- list(
  primers = "../../results/primers.tsv", 
  target_coords =
    "../../results/primer_mapping/captured_seq_coords_noprimers.bed"
)
```

# Primer Mapping Success

The set of primers that was output by `refmt_primers.R`, and therefore intended
for subsequent use in the pipeline, but not included in the mapping results, is 
below:

```{r}
# Read in primers and mapping results ----------------------------------
primers_all <- read_tsv(
  inp$primers, 
  col_types = cols(.default = col_character()), 
  progress = FALSE
)
mapping_results <- read_tsv(
    inp$target_coords, 
    col_names = c("chrom", "start_pos", "end_pos", "target"), 
    col_types = cols(
      .default = col_character(), 
      start_pos = col_integer(), 
      end_pos = col_integer()
    ), 
    progress = FALSE
  ) %>%
  mutate(target_length = end_pos - start_pos) %>%
  select(target, target_length)

# Identify primers that did not map successfully -----------------------
setdiff(primers_all$target, mapping_results$target)
```

This set is empty, which is what we want to see. This indicates mapping was
successful for each target.

The opposite, the difference between the mapping results and the input primer
set, is:

```{r}
setdiff(mapping_results$target, primers_all$target)
```

This is empty, which is also expected. A non-empty set would indicate a bug.

# Captured Sequence Length

```{r}
# Plot lengths of captured sequences -----------------------------------
mapping_results %>%
  ggplot(mapping = aes(x = target_length)) +
  geom_histogram(bins = 30) +
  labs(x = "Length of Captured Sequence", y = "No. of Targets")
```

All of the captured sequence lengths should be substantially less than 500 bp
(because we are using 250 bp reads), and this is the case.
