---
title: Performance of Marker Panel in May 2022 Run
author: Alfred Hubbard
output:
  html_notebook: default
  pdf_document: default
  github_document: default
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
# Load required libraries ----------------------------------------------
# These will be referenced without the `package::` construct, and thus 
# are loaded second to avoid masking
library(knitr)
library(magrittr)
library(tidyverse)

# Don't include code in PDF output
opts_chunk$set(echo = ! is_latex_output(), out.width = "100%")
# Set default ggplot2 theme
theme_set(theme_bw())

# Hardcode parameters. These are not passed as shell arguments because 
# hardcoded values facilitate development and this document is not 
# meant to be usable with other projects.
inp <- list(
  mh_combined = "../../resources/Microhap_PV_combined-data_2023-06-21"
)
out <- list(filtered_trgs = "../../results/trgs2filter/good_amp.csv")
```

```{r message = FALSE, fig.width = 20, fig.height = 17}
read_count_heatmap <- function(reads, 
                               fill_scale = scale_fill_fermenter(
                                 palette = "YlGnBu", 
                                 name = "Reads", 
                                 breaks = c(10, 100, 1000, 2000)
                               ), 
                               theme_tweaks = NULL) {
  ggplot(
      data = reads, 
      mapping = aes(x = target, y = sample_id, fill = n_read)
    ) +
    geom_tile() +
    facet_wrap(vars(treatment_source), ncol = 1) +
    fill_scale +
    labs(x = "Marker", y = "Sample") +
    theme(
      axis.text.x = element_text(angle = 90, hjust = 1), 
      legend.position = "bottom", 
      legend.key.width = unit(0.35, "in")
    ) +
    theme_tweaks
}

# Read in data ---------------------------------------------------------
mh_combined <- read_csv(
    inp$mh_combined, 
    col_types = cols(
      .default = col_integer(), 
      Primer = col_character(), 
      SeqRun = col_character(), 
      SID = col_character(), 
      Source = col_character(), 
      Dilution = col_character(), 
      Treatment = col_character(), 
      Primer_set = col_character(), 
      CT_Pv = col_double(), 
      CT_PfvarATS = col_double(), 
      CT_Pf18s = col_double(), 
      ParasiteDensity = col_double(), 
      Mixed = col_character(), 
      Median_reads_primer = col_double(), 
      Prop_value = col_double(), 
      Sequence = col_character(), 
      mh_allele_snps = col_character(), 
      mh_loci = col_character(), 
      TajimasD = col_double(), 
      Pnorm = col_double(), 
      Pbet = col_double()
    ), 
    progress = FALSE
  ) %>%
  select(-`...1`) %>%
  filter(SeqRun == "may2022", Primer_set == "OLD", Dilution == "Neat")

# Calculate total reads ------------------------------------------------
total_reads <- mh_combined %>%
  rename(target = Primer, sample_id = SID) %>%
  unite(treatment_source, Treatment, Source) %>%
  group_by(target, sample_id, treatment_source) %>%
  summarize(n_read = sum(Reads), .groups = "drop") %>%
  complete(target, sample_id, treatment_source, fill = list(n_read = 0))

# Plot read counts for each sample/target for the DBS treatments -------
whole_blood_samples <- mh_combined %>%
  filter(str_detect(Source, "Whole blood")) %$%
  unique(SID)
total_reads %>%
  filter(
    ! sample_id %in% whole_blood_samples, 
    ! str_detect(treatment_source, "Whole blood")
  ) %>%
  read_count_heatmap()
```

These heatmaps show the total reads obtained for each sample/target combination
for all of the DBS treatments.

```{r message = FALSE, fig.width = 20, fig.height = 8}
# Plot read counts for each sample/target for whole blood trials -------
total_reads %>%
  filter(
    sample_id %in% whole_blood_samples, 
    str_detect(treatment_source, "Whole blood")
  ) %>%
  read_count_heatmap()
```

These heatmaps show the same thing, except for the library prep methods that
utilized whole blood.

The point of this analysis is to identify any markers that consistently don't
amplify and should not be included in the MalariaGEN analyses. These plots
indicate three markers that consistently yield poor results. A marker set
without these problematic markers is created for use in subsequent analyses.

```{r}
# Filter targets to analysis set and save ------------------------------
total_reads %>%
  select(target) %>%
  distinct() %>%
  filter(
    ! target %in% c(
      "PvP01_07_v1_500001_500200", 
      "PvP01_14_v1_1887501_1887700", 
      "PvP01_14_v1_2759601_2759800"
    )
  ) %>%
  write_csv(out$filtered_trgs)
```
