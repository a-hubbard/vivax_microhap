---
title: Quantification of Microhaplotypes Identified by AmpSeq
author: Alfred Hubbard
output:
  html_notebook: default
  pdf_document: default
  github_document: default
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
# Load required libraries ----------------------------------------------
# These will be referenced without the `package::` construct, and thus 
# are loaded second to avoid masking
library(knitr)
library(magrittr)
library(tidyverse)

# Don't include code in PDF output
opts_chunk$set(echo = ! is_latex_output(), out.width = "100%")
# Set default ggplot2 theme
theme_set(theme_bw())

# Hardcode parameters. These are not passed as shell arguments because 
# hardcoded values facilitate development and this document is not 
# meant to be usable with other projects.
inp <- list(
  reads_summary = "../../results/AmpSeq/uci1223/run_dada2/reads_summary.txt", 
  cigar_table = "../../results/AmpSeq/uci1223/asv2cigar/seqtab_cigar.tsv"
)
out <- list(read_counts = "../../results/AmpSeq/uci1223/read_counts.csv")
```

# Final Data Quantity

## Reads

```{r fig.width = 15, fig.height = 35}
read_count_heatmap <- function(reads) {
  ggplot(data = reads, mapping = aes(x = locus, y = sample, fill = n_read)) +
    geom_tile() +
    scale_fill_fermenter(
      palette = "YlGnBu", 
      name = "Reads", 
      breaks = c(10, 100, 1000, 2000)
    ) +
    labs(x = "Locus", y = "Replicate") +
    theme(
      axis.text.x = element_text(angle = 60, hjust = 1), 
      legend.position = "bottom", 
      legend.key.width = unit(0.35, "in")
    )
}

# Read in final, filtered data -----------------------------------------
final_data <- read_tsv(
    inp$cigar_table, 
    col_types = cols(.default = col_integer(), sample = col_character()), 
    progress = FALSE
  ) %>%
  pivot_longer(-sample, names_to = "locus_cigar", values_to = "n_read") %>%
  separate_wider_delim(locus_cigar, ",", names = c("locus", "cigar"))

# Plot reads by sample and locus ---------------------------------------
final_reads <- final_data %>%
  group_by(sample, locus) %>%
  summarize(n_read = sum(n_read), .groups = "drop")
# Save for publication figures
final_reads %>%
  write_csv(out$read_counts)
final_reads %>%
  # filter(! str_detect(sample, "Control")) %>%
  read_count_heatmap()
```

This heatmap shows the number of reads in the final dataset for each
locus-replicate combination. These results closely mirror those presented in 
ampseqc_results.Rmd, which is expected and therefore reassuring.

# Filtering at Each Step

```{r}
# Read in read filtering information -----------------------------------
reads_summary <- read_table(
  inp$reads_summary, 
  col_names = c(
    "sample", 
    "input", 
    "filtered", 
    "denoisedF", 
    "denoisedR", 
    "merged", 
    "nonchim"
  ), 
  col_types = cols(.default = "i", sample = "c"), 
  skip = 1, 
  progress = FALSE
)

# Join final read counts -----------------------------------------------
reads_by_step <- final_reads %>%
  group_by(sample) %>%
  summarize(n_read = sum(n_read), .groups = "drop") %>%
  right_join(reads_summary, by = "sample") %>%
  rename(final = n_read) %>%
  relocate(final, .after = last_col()) %>%
  pivot_longer(-sample, names_to = "workflow_step", values_to = "n_read") %>%
  group_by(workflow_step) %>%
  summarize(n_read = sum(n_read), .groups = "drop") %>%
  mutate(
    workflow_step = factor(
      workflow_step, 
      c(
        "input", 
        "filtered", 
        "denoisedF", 
        "denoisedR", 
        "merged", 
        "nonchim", 
        "final"
      )
    )
  ) %>%
  arrange(workflow_step)
reads_by_step
```

This table shows the total number of reads after each step in the DADA2 part of
the pipeline plus the final filtering done by `ASV_to_CIGAR.py`. At no point is 
there an order(s) of magnitude reduction in the data volume, which would 
indicate cause for concern.
